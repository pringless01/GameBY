name: Deploy to Server

on:
  push:
    branches: [ "main" ]   # PR'da secrets ge√ßmez; main'e push √ßalƒ±≈üƒ±r
  workflow_dispatch: {}     # Elle tetiklemek i√ßin

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: ‚úÖ Sanity check secrets
        run: |
          [[ -n "${{ secrets.SERVER_HOST }}" ]] || (echo "‚ùå Missing SERVER_HOST" && exit 1)
          [[ -n "${{ secrets.SERVER_USER }}" ]] || (echo "‚ùå Missing SERVER_USER" && exit 1)
          [[ -n "${{ secrets.SERVER_SSH_KEY }}" ]] || (echo "‚ùå Missing SERVER_SSH_KEY" && exit 1)
          echo "‚úÖ Secrets look set."

      - name: ÔøΩ Sync repo to server (/opt/gameby)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "."
          target: "/opt/gameby"
          overwrite: true

      - name: ÔøΩüîê SSH to Server and Deploy
        uses: appleboy/ssh-action@v1.2.0
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          CURSOR_SECRET: ${{ secrets.CURSOR_SECRET }}
          CURSOR_SECRET_ROTATION: ${{ secrets.CURSOR_SECRET_ROTATION }}
          REFRESH_SECRET: ${{ secrets.REFRESH_SECRET }}
          CORS_ORIGIN: ${{ secrets.CORS_ORIGIN }}
          BASIC_AUTH_USER: ${{ secrets.BASIC_AUTH_USER }}
          BASIC_AUTH_PASS: ${{ secrets.BASIC_AUTH_PASS }}
          AGENT_ENABLED: ${{ secrets.AGENT_ENABLED }}
          AGENT_CONFIG_PATH: ${{ secrets.AGENT_CONFIG_PATH }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          envs: JWT_SECRET,CURSOR_SECRET,CURSOR_SECRET_ROTATION,REFRESH_SECRET,CORS_ORIGIN,BASIC_AUTH_USER,BASIC_AUTH_PASS,AGENT_ENABLED,AGENT_CONFIG_PATH
          script_stop: true
          script: |
            set -euo pipefail
            echo "‚û°Ô∏è  Starting deploy on $(hostname)"
            cd /opt/gameby

            # Ensure docker + compose plugin exist (Ubuntu/Debian best-effort)
            if ! command -v docker >/dev/null 2>&1; then
              echo "Installing Docker..."
              if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y ca-certificates curl gnupg
                sudo install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/$(. /etc/os-release; echo "$ID")/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                echo \
                  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/$(. /etc/os-release; echo "$ID") \"$(. /etc/os-release; echo "$VERSION_CODENAME")\" stable" | \
                  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                sudo apt-get update -y
                sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
              else
                echo "‚ö†Ô∏è  Non-apt distro, please pre-install Docker."; exit 1
              fi
            fi

            # Create .env from provided secrets (if set)
            echo "Writing .env (masked)"
            umask 077
            cat > .env << EOF
            # Generated by GitHub Actions deploy
            JWT_SECRET=${JWT_SECRET}
            CURSOR_SECRET=${CURSOR_SECRET}
            CURSOR_SECRET_ROTATION=${CURSOR_SECRET_ROTATION}
            REFRESH_SECRET=${REFRESH_SECRET}
            CORS_ORIGIN=${CORS_ORIGIN}
            BASIC_AUTH_USER=${BASIC_AUTH_USER}
            BASIC_AUTH_PASS=${BASIC_AUTH_PASS}
            AGENT_ENABLED=${AGENT_ENABLED}
            AGENT_CONFIG_PATH=${AGENT_CONFIG_PATH}
            EOF

            # Build and start
            echo "üöÄ docker compose up -d --build"
            sudo docker compose pull || true
            sudo docker compose up -d --build

            echo "‚è≥ Waiting for health..."
            for i in {1..30}; do
              if curl -fsS http://localhost/health >/dev/null; then echo "‚úÖ Nginx up"; break; fi
              sleep 2
            done
            curl -fsS http://localhost/health || (echo "‚ùå Health failed"; sudo docker compose ps; exit 1)

            echo "‚úÖ Deploy completed"
