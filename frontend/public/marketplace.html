<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Pazar - Ticaret Oyunu</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/navigation.css">
  <style>
    .market-container{max-width:428px;margin:0 auto;padding:16px;font-family:Inter,system-ui,sans-serif;}
    .offer{background:#1f1f23;border:1px solid #333;padding:12px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
    .offer .meta{font-size:13px;color:#b5b5c0;}
    .badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:11px;background:#263238;color:#fff;margin-left:6px;}
    .btn{background:#2e7d32;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:14px;}
    .btn-outline{background:transparent;border:1px solid #2e7d32;color:#2e7d32;}
    .toolbar{display:flex;gap:8px;margin-bottom:14px;}
    #offer-form{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;}
    #offer-form input{background:#121214;border:1px solid #333;color:#fff;padding:6px 8px;border-radius:6px;width:calc(50% - 6px);}
    #offers-empty{padding:24px;text-align:center;color:#888;}
    #toast{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:8px 14px;border-radius:20px;font-size:14px;opacity:0;transition:.3s;}
    #toast.show{opacity:1;}
    .balance-badge{background:#004d40;color:#fff;padding:4px 10px;border-radius:20px;font-size:12px;margin-left:auto;display:flex;align-items:center;gap:4px;}
  </style>
</head>
<body>
  <div class="mobile-container">
    <header class="navigation-header">
      <nav class="page-navigation">
        <a href="/index.html">üè†</a>
        <a href="/chat.html">üí¨</a>
        <a href="/marketplace.html" class="active">üè™</a>
      </nav>
    </header>
    <main class="market-container">
      <h1 style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">Pazar <span class="badge" id="offer-count">0</span><span class="balance-badge" id="balance">üí∞ 0 TL</span></h1>
      <div class="toolbar">
        <button class="btn-outline" id="refresh-btn">Yenile</button>
        <button class="btn" id="new-offer-btn">Yeni Teklif</button>
      </div>
      <form id="offer-form" class="d-none">
        <input type="text" id="subject" placeholder="√úr√ºn (Odun)" required>
        <input type="number" id="amount" placeholder="Miktar" required>
        <input type="number" id="price" placeholder="Toplam Fiyat" required>
        <input type="text" id="currency" placeholder="Para Birimi (TL)" value="TL">
        <button type="submit" class="btn" style="width:100%">Olu≈ütur</button>
      </form>
      <div id="offers"></div>
      <div id="offers-empty" class="d-none">Hi√ß teklif yok. ƒ∞lk sen olu≈ütur!</div>
    </main>
  </div>
  <div id="toast"></div>
  <script>
    const API_BASE='/api/contracts';
    const offersEl=document.getElementById('offers');
    const emptyEl=document.getElementById('offers-empty');
    const countEl=document.getElementById('offer-count');
    const form=document.getElementById('offer-form');
    const newOfferBtn=document.getElementById('new-offer-btn');
    const refreshBtn=document.getElementById('refresh-btn');
    const toastEl=document.getElementById('toast');
    let currentUserId=null;
    let currentMoney=0;
    const balanceEl=document.getElementById('balance');
    function toast(msg){toastEl.textContent=msg;toastEl.classList.add('show');setTimeout(()=>toastEl.classList.remove('show'),3000);}
    function token(){return localStorage.getItem('jwt_token');}
    function authHeaders(){return {'Content-Type':'application/json','Authorization':'Bearer '+token()};}
    function updateBalanceDisplay(){ if(balanceEl) balanceEl.textContent=`üí∞ ${currentMoney} TL`; }
    async function loadProfile(){ try{const r=await fetch('/api/user/profile',{headers:authHeaders()}); if(r.ok){const j=await r.json(); currentUserId=j.user.id; currentMoney=j.user.resources.money; updateBalanceDisplay(); }}catch(e){} }
    function render(contracts){offersEl.innerHTML='';if(!contracts.length){emptyEl.classList.remove('d-none');}else{emptyEl.classList.add('d-none');}
      contracts.forEach(c=>{const div=document.createElement('div');div.className='offer';
        let actionBtn='';
        if(c.status==='PENDING'){actionBtn=`<button class='btn' data-id='${c.id}' data-action='accept'>Katƒ±l</button>`;}
        else if(c.status==='ACTIVE'){
          const disabled = (c.creator_id===currentUserId && c.price>currentMoney) ? 'disabled title="Yetersiz bakiye"' : '';
          actionBtn=`<button class='btn' data-id='${c.id}' data-action='complete' ${disabled}>Tamamla</button>`;
        } else {actionBtn=`<button class='btn-outline' disabled>Durum: ${c.status}</button>`;}
        div.innerHTML=`<div><strong>${c.subject}</strong><div class="meta">${c.amount} adet ‚Ä¢ ${c.type} ‚Ä¢ ${c.status} ‚Ä¢ ${c.price||0} ${c.currency||'TL'}</div></div><div>${actionBtn}</div>`;offersEl.appendChild(div);});countEl.textContent=contracts.length;}
    async function load(){const r=await fetch(API_BASE,{headers:authHeaders()});if(r.ok){const j=await r.json();render(j.contracts);}else{toast('Y√ºklenemedi');}}
    offersEl.addEventListener('click', async e=>{const btn=e.target.closest('button[data-id]');if(!btn)return;const id=btn.dataset.id;const action=btn.dataset.action; if(action){const r=await fetch(`${API_BASE}/${id}/action`,{method:'POST',headers:authHeaders(),body:JSON.stringify({action})});if(r.ok){toast('OK');load();}else{const err=await r.json().catch(()=>({}));toast(err.error||'Hata');}}});
    newOfferBtn.addEventListener('click', () => {form.classList.toggle('d-none');});
    form.addEventListener('submit', async e=>{e.preventDefault();const subject=document.getElementById('subject').value.trim();const amount=Number(document.getElementById('amount').value);const price=Number(document.getElementById('price').value);const currency=(document.getElementById('currency').value||'TL').trim();if(!subject||!amount||!price){toast('Eksik');return;}const body={counterparty_id:1,subject,amount,type:'trade',price,currency};const r=await fetch(API_BASE,{method:'POST',headers:authHeaders(),body:JSON.stringify(body)});if(r.ok){toast('Teklif olu≈üturuldu');form.reset();form.classList.add('d-none');load();}else{toast('Hata')};});
    refreshBtn.addEventListener('click',load);
    document.addEventListener('DOMContentLoaded',()=>{loadProfile();load();});
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const s=io();
    s.on('contract_created',()=>load());
    s.on('contract_updated',()=>{loadProfile();load();});
    s.on('resource_updated',data=>{ if(data.userId===currentUserId){ currentMoney=data.resources.money; updateBalanceDisplay(); }});
  </script>
</body>
</html>
