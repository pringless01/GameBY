<!doctype html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="description" content="2D Online Ticaret Oyunu - Güven odaklı ticaret ekosistemi" />
    <meta name="theme-color" content="#000" />
    <!-- Prefetch is created dynamically in JS unless splashOnly=1 -->
    <title>CODARA GAME — Splash Intro (Neon)</title>
    <style>
    :root{
        --bg:#000;
        --cyan:#00d1ff;
        --cyan-soft:#64e8ff;
        --white:#ffffff;
        --white-soft:#eaf4ff;

        --max-w:1080px;
        --logo-size:clamp(260px,40vw,600px);

        --glow-tight:2px;
        --glow-mid:8px;
        --glow-big:22px;

        --t-pulse:3.8s;
        --t-flicker:1.8s;
        --t-shine:3.2s;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
        margin:0; background:#000; color:#fff;
        font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Noto Sans";
        overflow:hidden;
    }

    .codara-intro{
        position:fixed; inset:0; z-index:9999; background:#000;
        display:grid; place-items:center;
        transition:opacity .6s ease, visibility .6s ease;
    }
    .codara-intro.hidden{ opacity:0; visibility:hidden; pointer-events:none }

    .codara-intro::before{
        content:""; position:absolute; inset:0;
        background:
            radial-gradient(120% 100% at 50% 70%, rgba(0,0,0,.0) 0%, rgba(0,0,0,.65) 70%, rgba(0,0,0,.9) 100%),
            repeating-linear-gradient(to bottom, rgba(255,255,255,.03) 0 1px, rgba(0,0,0,0) 2px 3px);
        mix-blend-mode:normal; pointer-events:none;
    }

    .stage{
        position:relative; width:min(100%, var(--max-w)); aspect-ratio:16/9;
        display:flex; align-items:center; justify-content:center;
        isolation:isolate;
    }

    .halo{ position:absolute; inset:0; pointer-events:none; z-index:0; filter:blur(18px); opacity:.85; will-change: transform, opacity }
    .halo.top{
        background:radial-gradient(500px 320px at 50% 22%, rgba(0,209,255,.55) 0%, rgba(0,209,255,.2) 42%, rgba(0,209,255,0) 72%);
        animation: haloBreath var(--t-pulse) ease-in-out infinite;
    }
    .halo.bottom{
        background:radial-gradient(640px 280px at 50% 76%, rgba(255,255,255,.60) 0%, rgba(255,255,255,.18) 36%, rgba(255,255,255,0) 72%);
        animation: haloBreath var(--t-pulse) ease-in-out infinite reverse;
    }

    .stack{ position:relative; z-index:2; width:min(100%, var(--logo-size));
        display:flex; flex-direction:column; align-items:center; gap:clamp(16px,3vw,28px);
        transform: translateY(10px); opacity:0; filter:blur(8px);
        transition:opacity .9s ease, transform .9s ease, filter .9s ease;
        will-change: transform, opacity, filter;
    }
    .intro-on .stack{ opacity:1; transform:none; filter:none }

    .mark{
        display:flex; align-items:center; justify-content:center; gap:.33em;
        font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
        font-size:clamp(88px, 15vw, 200px); line-height:1;
        color:var(--cyan);
        text-shadow:
             0 0 var(--glow-tight) var(--cyan),
             0 0 var(--glow-mid) var(--cyan),
             0 0 var(--glow-big) var(--cyan-soft),
             0 0 calc(var(--glow-big)*1.6) var(--cyan-soft);
        transform:translateZ(0);
        will-change: transform, opacity;
        animation: pulse var(--t-pulse) ease-in-out infinite;
    }
    .brace{ font-weight:800 }
    .c{
        font-weight:800; font-size:.8em;
        text-shadow: 0 0 2px var(--cyan), 0 0 10px var(--cyan), 0 0 24px var(--cyan-soft);
    }

    .intro-on .mark{ animation: flicker var(--t-flicker) ease-in-out 1 both, pulse var(--t-pulse) ease-in-out infinite var(--t-flicker) }

    .word{ display:flex; flex-direction:column; align-items:center; gap:clamp(6px,1vw,10px) }
    .brand{
        position:relative; font-weight:800; letter-spacing:.02em;
        font-size:clamp(42px, 8vw, 104px); color:#fff;
        text-shadow: 0 0 1px #fff, 0 0 8px rgba(255,255,255,.25), 0 0 28px rgba(234,244,255,.6);
        transform:translateY(8px); opacity:0; filter:blur(6px);
        transition:transform .9s ease .5s, opacity .9s ease .5s, filter .9s ease .5s;
    }
    .intro-on .brand{ transform:none; opacity:1; filter:none }

    .brand::after{
        content:attr(data-text); position:absolute; inset:0; color:transparent;
        background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.0) 35%, rgba(255,255,255,.9) 50%, rgba(255,255,255,.0) 65%, transparent 100%);
        background-size:200% 100%; background-position:-120% 0;
        -webkit-background-clip:text; background-clip:text; mix-blend-mode:screen;
        animation: shine var(--t-shine) ease-in-out infinite 1s;
        pointer-events:none;
    }
    .tag{
        font-weight:700; letter-spacing:.32em; color:#fff; opacity:.96;
        font-size:clamp(16px, 3.2vw, 34px);
        text-shadow:0 0 1px #fff, 0 0 12px rgba(234,244,255,.6);
        transform:translateY(8px); opacity:0; filter:blur(6px);
        transition:transform .9s ease .7s, opacity .9s ease .7s, filter .9s ease .7s;
    }
    .intro-on .tag{ transform:none; opacity:1; filter:none }

    .brand.glitch::before,
    .brand.glitch::after{
        content:attr(data-text); position:absolute; inset:0; pointer-events:none;
    }
    .brand.glitch::before{
        color:#0ff; transform:translate(2px,-1px);
        clip-path: polygon(0 2%,100% 2%,100% 24%,0 24%);
        mix-blend-mode:screen;
    }
    .brand.glitch::after{
        color:#f0f; transform:translate(-2px,1px);
        clip-path: polygon(0 60%,100% 60%,100% 82%,0 82%);
        mix-blend-mode:screen;
    }

    #spark{ position:absolute; inset:0; z-index:1; pointer-events:none; }

    .skip{
        position:absolute; bottom:4.5vh; left:50%; transform:translateX(-50%);
        font-size:14px; letter-spacing:.08em; opacity:0; /* start hidden */
        text-shadow:0 0 6px rgba(255,255,255,.35);
        animation: none;
        transition: opacity .6s ease;
        user-select:none;
    }
    .skip.show{ opacity:.75; animation: hint 1.6s ease-in-out infinite; }

    @media (hover:hover){
        .codara-intro:hover .mark{ transform:scale(1.02) }
    }

    /* Use opacity+scale instead of filter brightness for cheaper compositing */
    @keyframes pulse { 0%,100%{ opacity:1; transform: translateZ(0) scale(1) } 50%{ opacity:.92; transform: translateZ(0) scale(1.015) } }
    @keyframes haloBreath { 0%,100%{ opacity:.75; transform:translateY(0) scale(1) } 50%{ opacity:.95; transform:translateY(-2px) scale(1.02) } }
    @keyframes shine { 0%{ background-position:-120% 0 } 50%{ background-position:120% 0 } 100%{ background-position:120% 0 } }
    @keyframes flicker{ 0%{ opacity:.05 } 7%{ opacity:1 } 12%{ opacity:.35 } 18%{ opacity:1 } 28%{ opacity:.55 } 36%{ opacity:1 } 100%{ opacity:1 } }
    @keyframes hint{ 0%,100%{ opacity:.35 } 50%{ opacity:.9 } }

    /* Low power mode tweaks (set via JS by adding .lowpower on body) */
    .lowpower .halo{ filter:blur(10px); opacity:.6 }
    .lowpower .mark{ text-shadow: 0 0 2px var(--cyan), 0 0 10px var(--cyan-soft) }
    .lowpower #spark{ filter:none }

    @media (prefers-reduced-motion:reduce){
        .halo,.mark,.brand::after,.brand,.tag{ animation:none !important }
        .codara-intro{ transition:opacity .2s ease, visibility .2s ease }
    }
    @media (max-aspect-ratio: 9/16){ .stage{ width:100%; height:100%; aspect-ratio:auto; } .stack{ width:min(86vw, var(--logo-size)); } }
    </style>
    </head>
    <body>

    <div id="codara-intro" class="codara-intro" role="dialog" aria-label="Giriş animasyonu">
        <div class="stage">
            <canvas id="spark"></canvas>
            <div class="halo top"></div>
            <div class="halo bottom"></div>

            <div class="stack">
                <div class="mark" aria-label="Codara mark">
                    <span class="brace">{</span><span class="c">C</span><span class="brace">}</span>
                </div>
                <div class="word" aria-label="Codara wordmark">
                    <div id="brand" class="brand" data-text="CODARA">CODARA</div>
                    <div class="tag">GAME</div>
                </div>
            </div>

            <button class="skip" type="button" aria-label="Atla" tabindex="0" id="skip-intro">Devam etmek için bir tuşa basın / tıklayın</button>
        </div>
    </div>

    <script src="/js/auth-client.js"></script>
    <script>
    (function(){
    const SPLASH_ONLY = /[?&]splashOnly=1/.test(location.search);
        const root = document.getElementById('codara-intro');
        const stage = root.querySelector('.stage');
        const brand = document.getElementById('brand');
        const spark = document.getElementById('spark');
                const skipBtn = document.getElementById('skip-intro');
            const ctx = spark.getContext && spark.getContext('2d');
            let glowSprite = null; // pre-rendered glow for particles
            let raf, particles = [], t0, dpi = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
                let done = false, cleaned = false;
            let shadowB = 18, particleCount = 90, quality = 'high';
            let emaDt = 16, degraded = false, frameInterval = 16, lastDraw = 0;
            const vw = Math.max(document.documentElement.clientWidth, window.innerWidth||0);
            const noHalo = /[?&]noHalo=1/.test(location.search);
            if(noHalo){ try{ root.querySelectorAll('.halo').forEach(el=> el.style.display='none'); }catch{} }
            // Create prefetch link unless splash-only
            if(!SPLASH_ONLY){
                try{
                    const l=document.createElement('link'); l.rel='prefetch'; l.href='/app.html'; document.head.appendChild(l);
                }catch{}
            }

            // Perf monitor toggle
            const urlPerf = /[?&]perf=1/.test(location.search);
            const perfEnabled = urlPerf || (localStorage.getItem('codaraPerf') === '1');
            let perfBox, frames=0, lastSec=performance.now(), fps=0, worst=0, longTasks=0;
            if(perfEnabled){
                perfBox = document.createElement('div');
                perfBox.style.cssText='position:fixed;top:6px;left:6px;z-index:10000;background:rgba(0,0,0,.65);color:#0f0;font:12px monospace;padding:6px 8px;border:1px solid rgba(0,255,0,.35);border-radius:6px;pointer-events:none;white-space:pre;line-height:1.3';
                document.body.appendChild(perfBox);
                const nav = (performance.getEntriesByType && performance.getEntriesByType('navigation')[0]) || performance.timing;
                let resSlow=0, resTotal=0;
                if('PerformanceObserver' in window){
                    try{
                        const poLT = new PerformanceObserver((list)=>{ for(const e of list.getEntries()){ if(e.duration>50) longTasks++; } });
                        poLT.observe({entryTypes:['longtask']});
                    }catch{}
                    try{
                        const poRes = new PerformanceObserver((list)=>{ for(const e of list.getEntries()){ resTotal++; if(e.duration>80) resSlow++; } });
                        poRes.observe({entryTypes:['resource']});
                    }catch{}
                }
                function renderPerf(){
                    const now = performance.now();
                    const ttfb = nav.responseStart ? (nav.responseStart - nav.startTime) : (performance.timing.responseStart - performance.timing.navigationStart);
                    const dcl = nav.domContentLoadedEventEnd ? (nav.domContentLoadedEventEnd - nav.startTime) : 0;
                    const load = nav.loadEventEnd ? (nav.loadEventEnd - nav.startTime) : 0;
                    perfBox.textContent = `FPS: ${String(fps).padStart(2,' ')}  worst: ${worst.toFixed(1)}ms  long: ${longTasks}\nTTFB: ${Math.max(0,ttfb|0)}ms  DCL: ${dcl?dcl|0:'--'}ms  Load: ${load?load|0:'--'}ms\nRes: ${resTotal}  slow(>80ms): ${resSlow}`;
                }
                setInterval(renderPerf, 500);
            }

                // Heuristic low-power detection
            const lowPower = (
                    window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches
                ) || (navigator.connection && (navigator.connection.saveData || ['slow-2g','2g'].includes(navigator.connection.effectiveType||'')))
                    || (navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 2);
            const smallScreen = vw <= 480;
            if(lowPower || smallScreen){ document.body.classList.add('lowpower'); quality = lowPower ? 'low' : 'mid'; particleCount = lowPower ? 24 : 36; shadowB = lowPower ? 8 : 12; dpi = smallScreen ? 1 : Math.min(dpi, 1.25); frameInterval = 33; }

        window.startCodaraIntro = function(opts={}){
            const {autoFinish=false, minHoldMs=2600, maxDurationMs=3800} = opts;
            return new Promise(resolve=>{
                root.classList.remove('hidden');
                requestAnimationFrame(()=> root.classList.add('intro-on'));

                                if(quality!== 'low'){
                                    setTimeout(()=> glitchOnce(), 1000);
                                    setTimeout(()=> glitchOnce(), 1600);
                                }

                                if(ctx){ initCanvas(); buildGlow(); spawnBurst(particleCount); animate(); }

                                                // Reveal CTA late in the sequence (~1.7s)
                                                try{ setTimeout(()=>{ const b = document.getElementById('skip-intro'); if(b) b.classList.add('show'); }, 1700); }catch{}

                                const forward = ()=> finish();
                                const evOpts = {once:true};
                                window.addEventListener('keydown', forward, evOpts);
                                window.addEventListener('pointerdown', forward, evOpts);
                                if(skipBtn) skipBtn.addEventListener('click', forward, evOpts);
                                document.addEventListener('visibilitychange', ()=>{ if(document.hidden) finish(); }, evOpts);
                                window.addEventListener('pagehide', forward, evOpts);

                let canFinishAt = performance.now() + minHoldMs;

                function finish(){
                    if(done) return;
                    done = true;
                    if(raf) cancelAnimationFrame(raf);
                    cleanup();
                    root.classList.add('hidden');
                    setTimeout(()=> resolve(), 620);
                }

                function cleanup(){
                    if(cleaned) return; cleaned = true;
                    try{ window.removeEventListener('keydown', forward); }catch{}
                    try{ window.removeEventListener('pointerdown', forward); }catch{}
                    try{ if(skipBtn) skipBtn.removeEventListener('click', forward); }catch{}
                    try{ window.removeEventListener('resize', resizeCanvas); }catch{}
                    try{ if(ctx){ ctx.clearRect(0,0,spark.width, spark.height); } }catch{}
                    try{ particles.length = 0; }catch{}
                    try{ glowSprite = null; }catch{}
                    try{ spark.width = 0; spark.height = 0; }catch{}
                }
            });
        };

    async function routeAfterIntro(){
        try{
            if(window.AuthClient){
                const logged = await AuthClient.isLoggedIn();
                if(perfEnabled && perfBox){ try{ perfBox.remove(); }catch{} }
                location.href = logged ? '/app.html' : '/login.html';
            } else {
                location.href = '/login.html';
            }
        }catch{ location.href = '/login.html'; }
    }

    // Skip immediately for reduced motion users
    if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches){
        document.getElementById('codara-intro').classList.add('hidden');
        routeAfterIntro();
    } else {
        startCodaraIntro({autoFinish:false}).then(()=>{ if(!SPLASH_ONLY){ routeAfterIntro(); } });
    }

        function glitchOnce(){ brand.classList.add('glitch'); setTimeout(()=> brand.classList.remove('glitch'), 160); }

    function initCanvas(){ resizeCanvas(); window.addEventListener('resize', resizeCanvas); t0 = performance.now(); }
        function resizeCanvas(){
            const r = stage.getBoundingClientRect();
            // Cap internal pixel count to keep mobile GPU fill-rate reasonable
            const maxPixels = 900000; // ~0.9 MPx budget
            let w = Math.max(1, Math.floor(r.width * dpi));
            let h = Math.max(1, Math.floor(r.height * dpi));
            const pixels = w * h;
            if(pixels > maxPixels){
                const scale = Math.sqrt(pixels / maxPixels);
                w = Math.max(1, Math.floor(w / scale));
                h = Math.max(1, Math.floor(h / scale));
            }
            spark.width = w;
            spark.height = h;
            spark.style.width = r.width + 'px';
            spark.style.height = r.height + 'px';
            const eff = w / Math.max(1, r.width);
            ctx.setTransform(eff,0,0,eff,0,0);
            ctx.globalCompositeOperation = 'lighter';
            ctx.imageSmoothingEnabled = true;
        }
        function buildGlow(){
            // Pre-render cyan glow sprite (radial gradient) to avoid expensive shadows per particle
            const size = Math.max(32, Math.floor(64 * dpi));
            const c = document.createElement('canvas');
            c.width = c.height = size;
            const g = c.getContext('2d');
            const r = size/2;
            const grad = g.createRadialGradient(r, r, 0, r, r, r);
            grad.addColorStop(0, 'rgba(0,209,255,0.95)');
            grad.addColorStop(0.35, 'rgba(0,209,255,0.55)');
            grad.addColorStop(1, 'rgba(0,209,255,0)');
            g.fillStyle = grad;
            g.beginPath(); g.arc(r, r, r, 0, Math.PI*2); g.fill();
            glowSprite = c;
        }
    function spawnBurst(n){
            particles.length = 0;
            const rect = stage.getBoundingClientRect();
            const cx = rect.width/2, cy = rect.height*0.56;
            for(let i=0;i<n;i++){
                const ang = (Math.random()*Math.PI - Math.PI/2) + (Math.random()*0.6-0.3);
                const spd = 120 + Math.random()*220;
                particles.push({
                    x: cx + (Math.random()*40-20),
                    y: cy + (Math.random()*10-5),
                    vx: Math.cos(ang)*spd,
                    vy: Math.sin(ang)*spd - 40,
                    life: 700 + Math.random()*900,
                    size: 1.2 + Math.random()*2.2,
                    t:0
                });
            }
        }
    function animate(now){
            raf = requestAnimationFrame(animate);
            if(!now) return;
            if(frameInterval > 16){
                if(now - (lastDraw||0) < frameInterval){ return; }
                lastDraw = now;
            }
            const dt = Math.min(48, now - (t0||now)); t0 = now;
            emaDt = emaDt*0.9 + dt*0.1;
            if(!degraded && emaDt > 26){ // adaptively lower quality if frame time degrades
                degraded = true; document.body.classList.add('lowpower');
                shadowB = Math.max(6, shadowB - 6); frameInterval = 33; dpi = 1; resizeCanvas();
                if(particles.length > 28) particles.length = 28;
            }
            ctx.clearRect(0,0,spark.width, spark.height);
            for(const p of particles){
                p.t += dt; const a = 1 - (p.t / p.life); if(a <= 0) continue;
                p.x += p.vx*dt/1000; p.y += p.vy*dt/1000; p.vy += 60*dt/1000;
                const alpha = 0.35 + 0.65*a; ctx.globalAlpha = alpha;
                if(glowSprite){
                    const s = p.size * 14; // scale factor to emulate previous shadow glow
                    ctx.drawImage(glowSprite, p.x - s/2, p.y - s/2, s, s);
                } else {
                    // Fallback: simple circle without shadow
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                    ctx.fillStyle = 'rgba(0,209,255,1)'; ctx.fill();
                }
            }
            ctx.globalAlpha = 1;

            // perf HUD update
            if(perfEnabled && perfBox){
                frames++;
                worst = Math.max(worst, dt);
                if(now - lastSec >= 1000){
                    fps = frames; frames = 0; lastSec = now;
                    perfBox.textContent = `FPS: ${String(fps).padStart(2,' ')}  worst: ${worst.toFixed(1)}ms  long: ${longTasks}`;
                    worst = 0;
                }
            }
        }
    })();
    </script>
    </body>
    </html>
