<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Pazar - Ticaret Oyunu</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/navigation.css">
  <style>
    .market-container{max-width:428px;margin:0 auto;padding:16px;font-family:Inter,system-ui,sans-serif;}
    .offer{background:#1f1f23;border:1px solid #333;padding:12px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
    .offer .meta{font-size:13px;color:#b5b5c0;}
    .badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:11px;background:#263238;color:#fff;margin-left:6px;}
    .btn{background:#2e7d32;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:14px;}
    .btn-outline{background:transparent;border:1px solid #2e7d32;color:#2e7d32;}
    .toolbar{display:flex;gap:8px;margin-bottom:14px;}
    #offer-form{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;}
    #offer-form input{background:#121214;border:1px solid #333;color:#fff;padding:6px 8px;border-radius:6px;width:calc(50% - 6px);}
    #offers-empty{padding:24px;text-align:center;color:#888;}
    #toast{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:8px 14px;border-radius:20px;font-size:14px;opacity:0;transition:.3s;}
    #toast.show{opacity:1;}
    .balance-badge{background:#004d40;color:#fff;padding:4px 10px;border-radius:20px;font-size:12px;margin-left:auto;display:flex;align-items:center;gap:4px;}
    .trust-reward-badge{background:#2e7d32;color:#fff;padding:2px 6px;border-radius:12px;font-size:10px;margin-left:4px;}
    .barter-group{display:flex;flex-wrap:wrap;gap:6px;width:100%;margin-top:4px;}
    .barter-group input{width:calc(33.33% - 6px);}    
    #trust-preview{background:#263238;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;display:none;width:100%;}
    #trust-preview.micro{background:#45220b;color:#ffb74d;}
    .filter-tabs{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;}
    .filter-tabs button{background:#263238;color:#ddd;border:1px solid #333;padding:6px 10px;border-radius:20px;font-size:12px;cursor:pointer;}
    .filter-tabs button.active{background:#2e7d32;color:#fff;border-color:#2e7d32;}
    .pagination{display:flex;gap:8px;justify-content:center;margin-top:12px;}
    .pagination button{background:#263238;color:#fff;border:1px solid #333;padding:4px 10px;border-radius:8px;cursor:pointer;font-size:12px;}
    .pagination button[disabled]{opacity:.4;cursor:not-allowed;}
  </style>
</head>
<body>
  <div class="mobile-container">
    <header class="navigation-header">
      <nav class="page-navigation">
        <a href="/index.html">üè†</a>
        <a href="/chat.html">üí¨</a>
        <a href="/marketplace.html" class="active">üè™</a>
      </nav>
    </header>
    <main class="market-container">
      <h1 style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">Pazar <span class="badge" id="offer-count">0</span><span class="balance-badge" id="balance">üí∞ 0 TL</span></h1>
      <div class="toolbar">
        <button class="btn-outline" id="refresh-btn">Yenile</button>
        <button class="btn" id="new-offer-btn">Yeni Teklif</button>
        <select id="sort-select" style="flex:1;background:#121214;color:#ddd;border:1px solid #333;border-radius:6px;padding:6px 8px;font-size:12px;">
          <option value="created_desc">Yeni</option>
          <option value="trust_desc">Trust ‚Üì</option>
          <option value="trust_asc">Trust ‚Üë</option>
          <option value="price_desc">Fiyat ‚Üì</option>
          <option value="price_asc">Fiyat ‚Üë</option>
        </select>
      </div>
      <div class="filter-tabs" id="filter-tabs">
        <button data-role="any" class="active">T√ºm√º</button>
        <button data-role="creator">Olu≈üturduklarƒ±m</button>
        <button data-role="counterparty">Bana Gelen</button>
        <button data-status="PENDING">Bekleyen</button>
        <button data-status="ACTIVE">Aktif</button>
        <button data-status="COMPLETED">Tamamlanan</button>
      </div>
      <form id="offer-form" class="d-none">
        <input type="text" id="subject" placeholder="√úr√ºn (Odun)" required>
        <input type="number" id="amount" placeholder="Miktar" required>
        <input type="number" id="price" placeholder="Toplam Fiyat" required>
        <input type="text" id="currency" placeholder="Para Birimi (TL)" value="TL">
        <div style="flex-basis:100%;font-size:12px;opacity:.8;margin-top:4px;">Barter (G√∂ndereceƒüin / Kar≈üƒ± tarafƒ±n g√∂ndereceƒüi kaynaklar)</div>
        <div class="barter-group">
          <input type="number" id="c_give_wood" placeholder="Ben Odun" min="0" value="0">
          <input type="number" id="c_give_grain" placeholder="Ben Tahƒ±l" min="0" value="0">
          <input type="number" id="c_give_business" placeholder="Ben ƒ∞≈ü" min="0" value="0">
          <input type="number" id="p_give_wood" placeholder="Kar≈üƒ± Odun" min="0" value="0">
          <input type="number" id="p_give_grain" placeholder="Kar≈üƒ± Tahƒ±l" min="0" value="0">
          <input type="number" id="p_give_business" placeholder="Kar≈üƒ± ƒ∞≈ü" min="0" value="0">
        </div>
        <div id="trust-preview"></div>
        <button type="submit" class="btn" style="width:100%">Olu≈ütur</button>
      </form>
      <div id="offers"></div>
      <div id="offers-empty" class="d-none">Hi√ß teklif yok. ƒ∞lk sen olu≈ütur!</div>
      <div class="pagination" id="pagination" style="display:none;">
        <button id="prev-page">√ñnceki</button>
        <span id="page-info" style="padding:4px 8px;font-size:12px;color:#bbb;"></span>
        <button id="next-page">Sonraki</button>
      </div>
    </main>
  </div>
  <div id="toast"></div>
  <script>
    const API_BASE='/api/contracts';
    const offersEl=document.getElementById('offers');
    const emptyEl=document.getElementById('offers-empty');
    const countEl=document.getElementById('offer-count');
    const form=document.getElementById('offer-form');
    const newOfferBtn=document.getElementById('new-offer-btn');
    const refreshBtn=document.getElementById('refresh-btn');
    const toastEl=document.getElementById('toast');
    let currentUserId=null;
    let currentMoney=0;
    const balanceEl=document.getElementById('balance');
    function toast(msg){toastEl.textContent=msg;toastEl.classList.add('show');setTimeout(()=>toastEl.classList.remove('show'),3000);}
    function token(){return localStorage.getItem('jwt_token');}
    function authHeaders(){return {'Content-Type':'application/json','Authorization':'Bearer '+token()};}
    function updateBalanceDisplay(){ if(balanceEl) balanceEl.textContent=`üí∞ ${currentMoney} TL`; }
    async function loadProfile(){ try{const r=await fetch('/api/user/profile',{headers:authHeaders()}); if(r.ok){const j=await r.json(); currentUserId=j.user.id; currentMoney=j.user.resources.money; updateBalanceDisplay(); }}catch(e){} }
    const MICRO_THRESHOLD = 5; // backend ile aynƒ±
    function barterValue(fields){
      return (fields.cw + fields.pw)*2 + (fields.cg + fields.pg)*2 + (fields.cb + fields.pb)*10; // backend katsayƒ±larƒ±
    }
    function estimateTrust(amount, price, bVal=0){
      amount = Math.max(1, amount||1); price = Math.max(1, price||1);
      const raw = 1 + Math.log10(amount * price * (bVal+1) + 1);
      const base = Math.min(10, Math.max(1, Math.round(raw)));
      return base;
    }
    function render(contracts){offersEl.innerHTML='';if(!contracts.length){emptyEl.classList.remove('d-none');}else{emptyEl.classList.add('d-none');}
      contracts.forEach(c=>{const div=document.createElement('div');div.className='offer';
        let actionBtn='';
        if(c.status==='PENDING'){actionBtn=`<button class='btn' data-id='${c.id}' data-action='accept'>Katƒ±l</button>`;}
        else if(c.status==='ACTIVE'){
          const disabled = (c.creator_id===currentUserId && c.price>currentMoney) ? 'disabled title="Yetersiz bakiye"' : '';
          actionBtn=`<button class='btn' data-id='${c.id}' data-action='complete' ${disabled}>Tamamla</button>`;
        } else {actionBtn=`<button class='btn-outline' disabled>Durum: ${c.status}</button>`;}
        const trustBadge = `<span class='trust-reward-badge'>${c.micro? '0' : ('~+'+c.estimated_trust)}‚≠ê</span>`;
        const barterInfo = c.barter_value? `<span class='badge'>Barter ${c.barter_value}</span>`:'';
        div.innerHTML=`<div><strong>${c.subject}</strong><div class="meta">${c.amount} adet ‚Ä¢ ${c.type} ‚Ä¢ ${c.status} ‚Ä¢ ${c.price||0} ${c.currency||'TL'} ${trustBadge} ${barterInfo}</div></div><div>${actionBtn}</div>`;offersEl.appendChild(div);});countEl.textContent=contracts.length;}
    let currentFilters={ role:'any', status:null, limit:10, offset:0, total:0, sort:'created_desc' };
    document.getElementById('sort-select').addEventListener('change', e=>{ currentFilters.sort=e.target.value; load(); });
    function applyFilters(){ currentFilters.offset=0; load(); }
    function buildQuery(){
      const p=new URLSearchParams();
      if(currentFilters.role && currentFilters.role!=='any') p.append('role', currentFilters.role);
      if(currentFilters.status) p.append('status', currentFilters.status);
      p.append('limit', currentFilters.limit);
      p.append('offset', currentFilters.offset);
      p.append('sort', currentFilters.sort);
      return p.toString();
    }
    async function load(){
      const q=buildQuery();
      const r=await fetch(API_BASE + (q? ('?'+q):''), {headers:authHeaders()});
      if(r.ok){
        const j=await r.json();
        render(j.contracts);
        currentFilters.total=j.total;
        updatePagination();
      } else { toast('Y√ºklenemedi'); }
    }
    function updatePagination(){
      const pagEl=document.getElementById('pagination');
      if(currentFilters.total <= currentFilters.limit){ pagEl.style.display='none'; return; }
      pagEl.style.display='flex';
      const page=Math.floor(currentFilters.offset/currentFilters.limit)+1;
      const totalPages=Math.ceil(currentFilters.total/currentFilters.limit);
      document.getElementById('page-info').textContent=page+" / "+totalPages;
      document.getElementById('prev-page').disabled = (page===1);
      document.getElementById('next-page').disabled = (page===totalPages);
    }
    document.addEventListener('click', e=>{
      const tab=e.target.closest('.filter-tabs button');
      if(tab){
        const role=tab.getAttribute('data-role');
        const status=tab.getAttribute('data-status');
        if(role){ currentFilters.role=role; document.querySelectorAll('.filter-tabs button[data-role]').forEach(b=>b.classList.remove('active')); tab.classList.add('active'); }
        if(status){ currentFilters.status = (currentFilters.status===status? null: status); document.querySelectorAll('.filter-tabs button[data-status]').forEach(b=>b.classList.remove('active')); if(currentFilters.status) tab.classList.add('active'); }
        applyFilters();
      }
    });
    document.getElementById('prev-page').addEventListener('click', ()=>{ if(currentFilters.offset>0){ currentFilters.offset -= currentFilters.limit; load(); }});
    document.getElementById('next-page').addEventListener('click', ()=>{ if(currentFilters.offset + currentFilters.limit < currentFilters.total){ currentFilters.offset += currentFilters.limit; load(); }});
    offersEl.addEventListener('click', async e=>{const btn=e.target.closest('button[data-id]');if(!btn)return;const id=btn.dataset.id;const action=btn.dataset.action; if(action){const r=await fetch(`${API_BASE}/${id}/action`,{method:'POST',headers:authHeaders(),body:JSON.stringify({action})});if(r.ok){toast('OK');load();}else{const err=await r.json().catch(()=>({}));toast(err.error||'Hata');}}});
    function updateTrustPreview(){
      const el=document.getElementById('trust-preview');
      const amount=Number(document.getElementById('amount').value)||0;
      const price=Number(document.getElementById('price').value)||0;
      const fields={
        cw:Number(document.getElementById('c_give_wood').value)||0,
        cg:Number(document.getElementById('c_give_grain').value)||0,
        cb:Number(document.getElementById('c_give_business').value)||0,
        pw:Number(document.getElementById('p_give_wood').value)||0,
        pg:Number(document.getElementById('p_give_grain').value)||0,
        pb:Number(document.getElementById('p_give_business').value)||0
      };
      const bVal=barterValue(fields);
      if(!amount || !price){ el.style.display='none'; return; }
      el.style.display='block';
      if(price < MICRO_THRESHOLD && bVal===0){
        el.classList.add('micro');
        el.textContent=`Tahmini Trust: 0 (mikro fiyat < ${MICRO_THRESHOLD} ve barter yok)`;
      } else {
        el.classList.remove('micro');
        const est=estimateTrust(amount, price, bVal);
        el.textContent=`Tahmini Trust: ~+${est}‚≠ê  (Barter deƒüer: ${bVal})`;
      }
    }
    ['amount','price','c_give_wood','c_give_grain','c_give_business','p_give_wood','p_give_grain','p_give_business']
      .forEach(id=>{document.addEventListener('input', e=>{ if(e.target && e.target.id===id) updateTrustPreview(); });});
    newOfferBtn.addEventListener('click', () => {form.classList.toggle('d-none');});
    form.addEventListener('submit', async e=>{
      e.preventDefault();
      const subject=document.getElementById('subject').value.trim();
      const amount=Number(document.getElementById('amount').value);
      const price=Number(document.getElementById('price').value);
      const currency=(document.getElementById('currency').value||'TL').trim();
      const body={
        counterparty_id:1,subject,amount,type:'trade',price,currency,
        creator_give_wood:Number(document.getElementById('c_give_wood').value)||0,
        creator_give_grain:Number(document.getElementById('c_give_grain').value)||0,
        creator_give_business:Number(document.getElementById('c_give_business').value)||0,
        counter_give_wood:Number(document.getElementById('p_give_wood').value)||0,
        counter_give_grain:Number(document.getElementById('p_give_grain').value)||0,
        counter_give_business:Number(document.getElementById('p_give_business').value)||0
      };
      if(!subject||!amount||!price){toast('Eksik');return;}
      const r=await fetch(API_BASE,{method:'POST',headers:authHeaders(),body:JSON.stringify(body)});
      if(r.ok){toast('Teklif olu≈üturuldu');form.reset();updateTrustPreview();form.classList.add('d-none');load();}
      else {const err=await r.json().catch(()=>({}));toast(err.error||'Hata');}
    });
    refreshBtn.addEventListener('click',load);
    document.addEventListener('DOMContentLoaded',()=>{loadProfile();load();});
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const s=io();
    s.on('contract_created',()=>load());
    s.on('contract_updated',()=>{loadProfile();load();});
    s.on('resource_updated',data=>{ if(data.userId===currentUserId){ currentMoney=data.resources.money; updateBalanceDisplay(); }});
  </script>
</body>
</html>
